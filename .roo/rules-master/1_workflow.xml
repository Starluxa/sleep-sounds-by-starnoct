<workflow>
  <overview>
    Master Mode orchestrates complex tasks by breaking them into 10+ subtasks, delegating to code mode, tracking progress, recording results, reviewing changes, and final reporting.
  </overview>

  <strict_rules>
    <rule>Never edit files except .md plan files. No terminal commands.</rule>
    <rule>Minimum 10 subtasks unless user specifies more.</rule>
    <rule>Only attempt_completion after all subtasks and review.</rule>
    <rule>Follow exact format for subtask delegation.</rule>
    <rule>Always gather context with codebase_search before exploring new areas of the code.</rule>
  </strict_rules>

  <steps>
    <step number="1">
      <title>Analyze Task and Gather Context</title>
      <actions>
        <action>Use codebase_search first, then list_files, list_code_definition_names, read_file, and search_files to understand project and task relevance.</action>
        <action>Use context7 MCP tools (resolve-library-id + query-docs) and access_mcp_resource as needed for best practices and docs.</action>
      </actions>
    </step>

    <step number="2">
      <title>Create Plan MD File</title>
      <actions>
        <action>Write task-plan-[timestamp].md with findings, best practices, and 10 subtasks plan (equal work).</action>
        <action>Plan MD must include: Scope, Key Findings, Risks/Constraints (esp. offline), Subtask List, and an Append-Only Results Log.</action>
      </actions>
    </step>

    <step number="3">
      <title>Initialize Todo List</title>
      <actions>
        <action>Use update_todo_list with numbered subtasks:
          Subtask 1: [short desc]
          ...
          Subtask 10: [short desc]
          Review Results</action>
      </actions>
    </step>

    <step number="4">
      <title>Delegate Subtask 1 to 10</title>
      <actions>
        <action>For each subtask, use new_task(mode="code", message=structured as specified, todos=fixed 4-item list)</action>
        <subtask_message_template>
          ## Subtask #X: [10+ words description]

          Background: [findings, code review]

          Relevant files/folders: [list]

          Context7 searches: [5 items]

          Rules: Do not mess up current features, offline access, unnecessary changes, major changes without MCP check.

          In attempt_completion: List unsolved issues & why; list all files created/edited/deleted.
        </subtask_message_template>
        <subtask_todos>
1. Read the top 10 Relevant files for this Subtask.
2. Use context7 mcp for 10 needed searches to develop a plan.
3. Use update_todo_list to insert 10 detailed todo list items in this spot after a plan is created.
4. Run attempt_completion after completing the 10 detailed todo list items you placed before this.
        </subtask_todos>
      </actions>
    </step>

    <step number="5">
      <title>Process Subtask Returns</title>
      <actions>
        <action>After each subtask attempt_completion, append results to plan MD under "Subtask X Results".</action>
        <action>Mark todo as [x], proceed to next.</action>
      </actions>
    </step>

    <step number="6">
      <title>Final Review</title>
      <actions>
        <action>Read all changed/created files, verify deletions.</action>
        <action>Append honest report to plan MD: Was user task fully implemented? Any messes? Unintended changes? Preserve offline access?</action>
      </actions>
    </step>

    <step number="7">
      <title>Attempt Completion</title>
      <actions>
        <action>Use attempt_completion with bullet points summarizing everything.</action>
      </actions>
    </step>
  </steps>
</workflow>
